const torch=document.getElementById('torch');
const dashboard=document.getElementById('dashboard');
const meter=document.getElementById('meter');
const modal=document.getElementById('modal');
const modalContent=document.getElementById('modal-content');
const log=document.getElementById('activity-log');

// Torch follow
document.addEventListener('mousemove', e=>{
  torch.style.left=e.clientX-250+'px';
  torch.style.top=e.clientY-250+'px';
});

// Signal Meter Animation
setInterval(()=>{meter.style.width=Math.floor(Math.random()*100)+'%';},1000);

// Draggable function
function makeDraggable(el){
  let isDragging=false, offsetX=0, offsetY=0;
  el.addEventListener('mousedown', e=>{
    isDragging=true;
    offsetX=e.offsetX;
    offsetY=e.offsetY;
  });
  document.addEventListener('mouseup', e=>{isDragging=false; saveState();});
  document.addEventListener('mousemove', e=>{
    if(!isDragging) return;
    el.style.left=e.clientX-offsetX+'px';
    el.style.top=e.clientY-offsetY+'px';
  });
}

// Make draggable initial cards
document.querySelectorAll('.case-card').forEach(makeDraggable);

// Sticky Notes & Images
document.getElementById('add-note').addEventListener('click',()=>{
  const note=document.createElement('div');
  note.className='sticky-note';
  note.style.top='50px';
  note.style.left='50px';
  note.contentEditable=true;
  note.innerHTML='<h4>New Note</h4><p>Edit me...</p>';
  dashboard.appendChild(note);
  makeDraggable(note);
  saveState();
});

document.getElementById('add-image').addEventListener('click',()=>{
  const input=document.createElement('input');
  input.type='file';
  input.accept='image/*';
  input.onchange=e=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{
      const imgCard=document.createElement('div');
      imgCard.className='image-card';
      imgCard.style.top='100px';
      imgCard.style.left='100px';
      imgCard.innerHTML=`<img src="${ev.target.result}">`;
      dashboard.appendChild(imgCard);
      makeDraggable(imgCard);
      logActivity("Ghost snapshot added!");
      saveState();
    }
    reader.readAsDataURL(file);
  };
  input.click();
});

// Modal functions
function openModal(content){
  modalContent.innerHTML=content;
  modal.style.display='block';
}
document.getElementById('close-modal').addEventListener('click',()=>{modal.style.display='none';});

// Desk items
document.getElementById('desk-clipboard').addEventListener('click',()=>{openModal('<textarea>New notes...</textarea>');});
document.getElementById('desk-magazine').addEventListener('click',()=>{openModal('<p>Magazine contents...</p>');});
document.getElementById('desk-phone').addEventListener('click',()=>{openModal('<p>Incoming Call Logs...</p>');});
document.getElementById('desk-mug').addEventListener('click',()=>{openModal('<p>Just coffee ☕</p>');});

// Paranormal Gadgets with Activity Log updates
function logActivity(text){
  const time=new Date();
  const h=time.getHours().toString().padStart(2,'0');
  const m=time.getMinutes().toString().padStart(2,'0');
  log.innerHTML += `• ${h}:${m} – ${text}<br>`;
  log.scrollTop = log.scrollHeight;
}

document.getElementById('desk-emf').addEventListener('click',()=>{
  const reading=Math.floor(Math.random()*5)+1;
  openModal(`<p>EMF Reading: ${reading} mG</p>`);
  logActivity(`EMF Reading detected: ${reading} mG`);
});

document.getElementById('desk-camera').addEventListener('click',()=>{
  openModal('<p>Paranormal Snapshot Captured!</p><img src="https://images.unsplash.com/photo-1566231552953-11b0c1abbdc0" alt="ghost">');
  logActivity("Ghost snapshot taken");
});

document.getElementById('desk-spirit').addEventListener('click',()=>{
  openModal('<p>Spirit Box Activated: "Whisper... Whisper..."</p>');
  logActivity("Spirit whispers detected");
});

document.getElementById('desk-thermo').addEventListener('click',()=>{
  const temp=Math.floor(Math.random()*10)+15;
  openModal(`<p>Temperature: ${temp}°C</p>`);
  logActivity(`Temperature drop detected: ${temp}°C`);
});

// Save & Load Board State
function saveState(){
  const items=[];
  dashboard.querySelectorAll('.case-card, .sticky-note, .image-card').forEach(el=>{
    items.push({type:el.className, html:el.innerHTML, top:el.style.top, left:el.style.left});
  });
  localStorage.setItem('dashboardItems',JSON.stringify(items));
  localStorage.setItem('activityLog',log.innerHTML);
}

function loadState(){
  const items=JSON.parse(localStorage.getItem('dashboardItems')||'[]');
  dashboard.querySelectorAll('.case-card, .sticky-note, .image-card').forEach(el=>el.remove());
  items.forEach(item=>{
    const el=document.createElement('div');
    el.className=item.type;
    el.innerHTML=item.html;
    el.style.top=item.top;
    el.style.left=item.left;
    dashboard.appendChild(el);
    makeDraggable(el);
  });
  log.innerHTML=localStorage.getItem('activityLog')||log.innerHTML;
}
window.addEventListener('load',loadState);
window.addEventListener('beforeunload',saveState);

// Make all new elements draggable
function makeDraggable(el){
  let isDragging=false, offsetX=0, offsetY=0;
  el.addEventListener('mousedown', e=>{
    isDragging=true;
    offsetX=e.offsetX;
    offsetY=e.offsetY;
  });
  document.addEventListener('mouseup', e=>{isDragging=false; saveState();});
  document.addEventListener('mousemove', e=>{
    if(!isDragging) return;
    el.style.left=e.clientX-offsetX+'px';
    el.style.top=e.clientY-offsetY+'px';
  });
}
